(function(b){b.fn.freetile=function(c){if(typeof a[c]==="function"){return a[c].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof c==="object"||!c){return a.init.apply(this,arguments)}else{b.error("Method "+c+" does not exist on jQuery.Freetile")}}return this};var a={init:function(d){var c=this;var e=a.setupOptions(c,d);if(!e.tiled){a.setupContainerBindings(c,e)}if(e.tiled&&!b.isEmptyObject(e.contentToAppend)){c.append(e.contentToAppend);e.contentToAppend.filter(e.selector||"*").imagesLoaded(function(){a.positionAll(c,e)})}else{c.imagesLoaded(function(){a.positionAll(c,e)})}return c},append:function(d){var c=this;var e=a.setupOptions(c,d);if(e.tiled&&!b.isEmptyObject(e.contentToAppend)){c.append(e.contentToAppend);e.contentToAppend.imagesLoaded(function(){a.positionAll(c,e)})}return c},layout:function(c){var d=a.setupOptions(this,c);a.positionAll(this,d);return this},setupOptions:function(d,e){var c=d.data("FreetileData");var f=b.extend(true,{},this.defaults,c,this.reset,e);d.data("FreetileData",f);f.tiled=(c!==undefined);f._animate=f.animate&&f.tiled&&b.isEmptyObject(f.contentToAppend);this.reset.callback=f.persistentCallback&&f.callback?f.callback:function(){};return f},setupContainerBindings:function(c,f){if(f.containerResize){var e=b(window),d=e.width(),g=e.height();e.resize(function(){clearTimeout(c.data("FreetileTimeout"));c.data("FreetileTimeout",setTimeout(function(){var i=e.width(),h=e.height();if(i!=d||h!=g){d=i,g=h;c.freetile("layout")}},400))})}if(f.customEvents){c.bind(f.customEvents,function(){clearTimeout(c.data("FreetileTimeout"));c.data("FreetileTimeout",setTimeout(function(){c.freetile("layout")},400))})}return c},calculatePositions:function(c,d,e){d.each(function(){var m=b(this),u=m.outerWidth(true),A=m.outerHeight(true),z=0,o=0,g=0,s=0,x=0;var p=e.currentPos[0].top;for(x=1;x<e.currentPos.length&&e.currentPos[x].left<u;x++){p=Math.max(p,e.currentPos[x].top)}g=x;s=e.scoreFunction(o,g,0,p,u,A);for(var y=1;(y<e.currentPos.length)&&(e.currentPos[y].left+u<=e.containerWidth);y++){var r=e.currentPos[y].top;for(x=y+1;(x<e.currentPos.length)&&(e.currentPos[x].left-e.currentPos[y].left<u);x++){r=Math.max(r,e.currentPos[x].top)}var w=e.scoreFunction(o,g,e.currentPos[y].left,r,u,A);if(w>s){o=y;g=x;p=r;s=w}}var v=m.position(),k={left:e.currentPos[o].left+e.xPadding,top:p+e.yPadding};if(v.top!=k.top||v.left!=k.left){var f={el:m,f:"css",d:0};if(e._animate&&!m.hasClass("noanim")){var q=m.offset(),h={left:k.left+(q.left-v.left),top:k.top+(q.top-v.top)};if((q.top+A>e.viewportY&&q.top<e.viewportYH||h.top+A>e.viewportY&&h.top<e.viewportYH)){f.f="animate";f.d=e.currentDelay;++(e.iteration);e.currentDelay+=e.elementDelay}}f.style=k;e.styleQueue.push(f)}--(e.iteration);var l=e.currentPos[g-1].top,n=e.currentPos[g]?e.currentPos[g].left:e.containerWidth;z=e.currentPos[o].left+u;e.currentPos[o].top=p+A;if(z<n){e.currentPos.splice(o+1,g-o-1,{left:z,top:l})}else{e.currentPos.splice(o+1,g-o-1)}})},applyStyles:function(f){var e;for(var d=0,c=f.styleQueue.length;d<c;d++){e=f.styleQueue[d];if(e.f=="animate"){e.el.delay(e.d).animate(e.style,b.extend(true,{},f.animationOptions))}else{e.el.css(e.style)}}},positionAll:function(c,g){if(b.isEmptyObject(g.contentToAppend)){var j=g.selector?c.children(g.selector):c.children()}else{var j=g.selector?g.contentToAppend.filter(g.selector):g.contentToAppend}g.ElementsCount=j.length;if(!g.ElementsCount){return(false)}var d=c.css("display")||"";var f=c.css("visibility")||"";c.css({display:"block",width:"",visibility:"hidden"});g.containerWidth=c.width();var i=c.data("FreetilePos");g.currentPos=!b.isEmptyObject(g.contentToAppend)&&i?i:[{left:0,top:0}];g.xPadding=parseInt(c.css("padding-left"),10);g.yPadding=parseInt(c.css("padding-top"),10);g.viewportY=b(window).scrollTop();g.viewportYH=g.viewportY+b(window).height();g.iteration=j.length;g.currentDelay=0;g.styleQueue=[];g.animationOptions.complete=function(){if(--(g.iteration)<=0){g.callback(g)}};j.css({position:"absolute"});a.calculatePositions(c,j,g);a.applyStyles(g);var h={};if(d){h.display=d}if(f){h.visibility=f}if(c.css("position")=="static"){h.position="relative"}if(g.forceWidth){h.width=g.containerWidthStep?g.containerWidthStep*(parseInt(c.width()/g.containerWidthStep,10)):g._columns*g._colWidth}c.css(h);var e=b.map(g.currentPos,function(l,k){return l.top});h={height:Math.max.apply(Math,e)};if(g._animate&&g.containerAnimate){c.stop().animate(h,b.extend(true,{},g.animationOptions))}else{c.css(h)}if(g.iteration<=0){g.callback(g)}c.data("FreetilePos",g.currentPos);j.addClass("tiled");return c},defaults:{selector:undefined,animate:false,elementDelay:0,containerResize:true,containerAnimate:true,customEvents:undefined,persistentCallback:false,forceWidth:false,containerWidthStep:undefined,scoreFunction:function(h,c,g,e,d,f){return -e}},reset:{animationOptions:{complete:function(){}},callback:function(){},contentToAppend:{}}};b.fn.imagesLoaded=function(m){var k=this,e=k.find("img:not(.load-complete)").add(k.filter("img:not(.load-complete)")),h=e.length,i=h,c=[],g="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";function d(){m.call(k,e)}function l(){if(b.fn.imagesLoaded.step){b.fn.imagesLoaded.step.call(k,i,h,e)}}function j(n){if(--i<=0){i=h;e.unbind("load error",j).bind("load error",f).each(function(){this.src=c.shift()})}}function f(n){setTimeout(l);if(--i<=0&&n.target.src!==g){setTimeout(d);e.unbind("load error",f).addClass("load-complete")}}if(!h){d()}e.bind("load error",j).each(function(){c.push(this.src);this.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=="});return k}})(jQuery);